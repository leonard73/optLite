i=imread('pic2.bmp');
r=double(i(:,:,1));
g=double(i(:,:,2));
b=double(i(:,:,3));
k_smooth=fspecial('gaussian',5,1.5);
lowF_r=conv2(r,k_smooth,'same');
lowF_g=conv2(g,k_smooth,'same');
lowF_b=conv2(b,k_smooth,'same');
Reflection_R=exp(log(r)-log(lowF_r));
Reflection_G=exp(log(g)-log(lowF_g));
Reflection_B=exp(log(b)-log(lowF_b));
maxR=max(max(Reflection_R));
maxG=max(max(Reflection_G));
maxB=max(max(Reflection_B));
Reflection_R=Reflection_R.*(255/maxR);
Reflection_G=Reflection_G.*(255/maxG);
Reflection_B=Reflection_B.*(255/maxB);
retinex_img=cat(3,Reflection_R,Reflection_G,Reflection_B);
imshow((uint8(retinex_img)));